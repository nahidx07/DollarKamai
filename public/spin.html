<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lucky Spin Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; color: white; overflow: hidden; user-select: none; }
        
        /* Wheel Design */
        .wheel-container { position: relative; width: 300px; height: 300px; margin: 40px auto; }
        .wheel-border { position: absolute; inset: -10px; border-radius: 50%; border: 4px solid #f59e0b; box-shadow: 0 0 20px rgba(245, 158, 11, 0.5); }
        .wheel { 
            width: 100%; height: 100%; border-radius: 50%; 
            background: conic-gradient(
                #ef4444 0deg 72deg,    /* 1x - Red */
                #3b82f6 72deg 144deg,  /* 2x - Blue */
                #10b981 144deg 216deg, /* 5x - Green */
                #a855f7 216deg 288deg, /* 10x - Purple */
                #f59e0b 288deg 360deg  /* 40x - Gold */
            );
            transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        
        /* Segments Text */
        .segment { position: absolute; width: 100%; height: 100%; text-align: center; font-weight: bold; font-size: 18px; text-shadow: 1px 1px 2px black; }
        .seg-1 { transform: rotate(36deg); } .seg-2 { transform: rotate(108deg); }
        .seg-5 { transform: rotate(180deg); } .seg-10 { transform: rotate(252deg); }
        .seg-40 { transform: rotate(324deg); }

        /* Pointer */
        .pointer { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); z-index: 20; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); }
        
        /* Button Animation */
        .btn-bet:active { transform: scale(0.95); }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- HEADER -->
    <div class="p-4 flex justify-between items-center bg-slate-800/80 backdrop-blur border-b border-slate-700 z-10">
        <div class="flex items-center gap-2">
            <button onclick="history.back()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-arrow-left"></i></button>
            <h2 class="font-bold text-yellow-400 flex items-center gap-2"><i class="fa-solid fa-coins"></i> <span id="bal">0</span></h2>
        </div>
        <div id="statusBadge" class="text-[10px] font-bold px-3 py-1 rounded-full bg-green-600 animate-pulse">LIVE BETTING</div>
    </div>

    <!-- WHEEL AREA -->
    <div class="flex-1 relative flex flex-col justify-center items-center">
        <div class="wheel-container">
            <div class="pointer"><i class="fa-solid fa-caret-down text-5xl text-white"></i></div>
            <div class="wheel-border"></div>
            <div class="wheel" id="wheel">
                <!-- Text Overlays -->
                <div class="segment seg-1"><div class="mt-4">1x</div></div>
                <div class="segment seg-2"><div class="mt-4">2x</div></div>
                <div class="segment seg-5"><div class="mt-4">5x</div></div>
                <div class="segment seg-10"><div class="mt-4">10x</div></div>
                <div class="segment seg-40"><div class="mt-4 text-black">40x</div></div>
            </div>
            <!-- Center Timer -->
            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                <div class="bg-slate-900/90 w-16 h-16 rounded-full flex items-center justify-center border-4 border-slate-700 shadow-xl z-10">
                    <h1 id="timer" class="text-2xl font-bold text-white">Wait</h1>
                </div>
            </div>
        </div>
        <p id="infoText" class="text-xs text-gray-400 mt-4">Place your bets!</p>
    </div>

    <!-- BETTING CONTROLS -->
    <div class="bg-slate-800 p-5 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.5)] z-20">
        <!-- Amount Selector -->
        <div class="flex justify-center gap-3 mb-5">
            <button onclick="setAmt(10)" class="amt-btn bg-slate-700 text-gray-300 px-4 py-1.5 rounded-lg text-xs font-bold border border-transparent hover:border-yellow-500 transition">10</button>
            <button onclick="setAmt(50)" class="amt-btn bg-slate-700 text-gray-300 px-4 py-1.5 rounded-lg text-xs font-bold border border-transparent hover:border-yellow-500 transition">50</button>
            <button onclick="setAmt(100)" class="amt-btn bg-slate-700 text-gray-300 px-4 py-1.5 rounded-lg text-xs font-bold border border-transparent hover:border-yellow-500 transition">100</button>
            <button onclick="setAmt(500)" class="amt-btn bg-slate-700 text-gray-300 px-4 py-1.5 rounded-lg text-xs font-bold border border-transparent hover:border-yellow-500 transition">500</button>
        </div>

        <!-- Multiplier Buttons -->
        <div class="grid grid-cols-5 gap-2">
            <button onclick="placeBet(1)" class="btn-bet bg-red-600 p-2 rounded-xl text-white font-bold flex flex-col items-center shadow-lg border-b-4 border-red-800 active:border-b-0 active:translate-y-1"><span>1x</span><span class="text-[8px] font-normal opacity-80 mt-1 bg-black/20 px-1 rounded" id="bet-1">0</span></button>
            <button onclick="placeBet(2)" class="btn-bet bg-blue-600 p-2 rounded-xl text-white font-bold flex flex-col items-center shadow-lg border-b-4 border-blue-800 active:border-b-0 active:translate-y-1"><span>2x</span><span class="text-[8px] font-normal opacity-80 mt-1 bg-black/20 px-1 rounded" id="bet-2">0</span></button>
            <button onclick="placeBet(5)" class="btn-bet bg-emerald-600 p-2 rounded-xl text-white font-bold flex flex-col items-center shadow-lg border-b-4 border-emerald-800 active:border-b-0 active:translate-y-1"><span>5x</span><span class="text-[8px] font-normal opacity-80 mt-1 bg-black/20 px-1 rounded" id="bet-5">0</span></button>
            <button onclick="placeBet(10)" class="btn-bet bg-purple-600 p-2 rounded-xl text-white font-bold flex flex-col items-center shadow-lg border-b-4 border-purple-800 active:border-b-0 active:translate-y-1"><span>10x</span><span class="text-[8px] font-normal opacity-80 mt-1 bg-black/20 px-1 rounded" id="bet-10">0</span></button>
            <button onclick="placeBet(40)" class="btn-bet bg-yellow-500 p-2 rounded-xl text-black font-bold flex flex-col items-center shadow-lg border-b-4 border-yellow-700 active:border-b-0 active:translate-y-1"><span>40x</span><span class="text-[8px] font-normal opacity-80 mt-1 bg-black/20 px-1 rounded" id="bet-40">0</span></button>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-slate-800/90 text-white px-4 py-2 rounded-full text-xs hidden shadow-xl z-50">Msg</div>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        // ⚠️⚠️⚠️ PASTE YOUR FIREBASE CONFIG HERE ⚠️⚠️⚠️
        const firebaseConfig = {
            apiKey: "AIzaSyCgVhOPt9w6UhZWop6QLmq7AO3cpZtsQmI",
            authDomain: "dollarkamai1.firebaseapp.com",
            projectId: "dollarkamai1",
            storageBucket: "dollarkamai1.firebasestorage.app",
            messagingSenderId: "278970320528",
            appId: "1:278970320528:web:30d08c635ed9e623f1ba15"
        };
        
        try{firebase.initializeApp(firebaseConfig);}catch(e){}
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;

        let userId = 123456; // Demo ID
        let selectedAmt = 10;
        let isSpinning = false;
        let targetTime = 0; // Server Time
        let currentRotation = 0; // Track rotation to prevent spin-back

        // Degree Mapping (Must match CSS gradients)
        // 1x: 36, 2x: 108, 5x: 180, 10x: 252, 40x: 324 (Center points)
        // We invert logic because wheel spins clockwise
        const winAngles = { 
            1: 360 - 36, 
            2: 360 - 108, 
            5: 360 - 180, 
            10: 360 - 252, 
            40: 360 - 324 
        };

        document.addEventListener('DOMContentLoaded', () => {
            tg.expand();
            if(tg.initDataUnsafe.user) userId = tg.initDataUnsafe.user.id;

            // Highlight Default Amount
            setAmt(10);

            // 1. Balance Listener
            db.collection('users').doc(userId.toString()).onSnapshot(doc => {
                if(doc.exists) document.getElementById('bal').innerText = doc.data().balance || 0;
            });

            // 2. GAME STATE LISTENER (The Heart of the Game)
            db.collection('gamestate').doc('live_round').onSnapshot(doc => {
                if(!doc.exists) { initGame(); return; }
                const data = doc.data();

                // Update Timer Target
                if(data.nextRoundTime) targetTime = data.nextRoundTime;

                // STATE: SPINNING
                if(data.status === 'SPINNING') {
                    document.getElementById('statusBadge').innerText = "SPINNING...";
                    document.getElementById('statusBadge').className = "text-[10px] font-bold px-3 py-1 rounded-full bg-red-600 animate-pulse";
                    if(!isSpinning) {
                        spinWheel(data.winner);
                    }
                } 
                // STATE: BETTING
                else {
                    document.getElementById('statusBadge').innerText = "LIVE BETTING";
                    document.getElementById('statusBadge').className = "text-[10px] font-bold px-3 py-1 rounded-full bg-green-600 animate-pulse";
                    if(isSpinning) {
                        resetGameUI();
                    }
                }
            });

            // Local Timer Loop (Syncs with server time)
            setInterval(updateTimer, 1000);
        });

        function updateTimer() {
            if(isSpinning) {
                document.getElementById('timer').innerText = "GO";
                return;
            }
            const now = Date.now();
            const diff = Math.ceil((targetTime - now) / 1000);

            if(diff > 0) {
                document.getElementById('timer').innerText = diff;
                document.getElementById('infoText').innerText = "Place your bets!";
            } else {
                document.getElementById('timer').innerText = "0";
                document.getElementById('infoText').innerText = "Waiting for result...";
                
                // Trigger Backend if time is up (Client-side trigger for serverless env)
                if(diff === 0 || diff === -1) {
                    fetch('/api/spin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'RESOLVE_GAME'}) });
                }
            }
        }

        function spinWheel(winner) {
            isSpinning = true;
            const wheel = document.getElementById('wheel');
            const targetAngle = winAngles[winner];
            
            // Calculate total rotation (Current + 5 Full Spins + Target)
            // Adding extra randomization (-10 to +10 deg) to make it look real
            const randomOffset = Math.floor(Math.random() * 20) - 10; 
            currentRotation += (360 * 5) + (targetAngle - (currentRotation % 360)) + randomOffset;

            wheel.style.transform = `rotate(${currentRotation}deg)`;

            setTimeout(() => {
                showToast(`Winner: ${winner}x`);
                // Call Reset
                if(Math.random() < 0.3) { // Random client triggers reset to avoid spam
                    fetch('/api/spin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'RESET_GAME'}) });
                }
            }, 5500); // Wait for animation
        }

        function resetGameUI() {
            isSpinning = false;
            // Clear Bet Amounts UI
            for(let i of [1,2,5,10,40]) document.getElementById('bet-'+i).innerText = '0';
        }

        function setAmt(n) { 
            selectedAmt=n; 
            document.querySelectorAll('.amt-btn').forEach(b=>{
                b.classList.remove('bg-yellow-500', 'text-black', 'border-yellow-500');
                b.classList.add('bg-slate-700', 'text-gray-300');
            }); 
            event.target.classList.remove('bg-slate-700', 'text-gray-300');
            event.target.classList.add('bg-yellow-500', 'text-black', 'border-yellow-500');
        }

        function placeBet(mult) {
            if(isSpinning) return showToast("Wait for next round!");
            
            // Optimistic UI Update (Instant Feedback)
            const betEl = document.getElementById('bet-'+mult);
            betEl.innerText = parseInt(betEl.innerText) + selectedAmt;

            // API Call
            fetch('/api/spin', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'PLACE_BET', userId: userId.toString(), betOn: mult, amount: selectedAmt })
            }).then(res => res.json()).then(data => {
                if(data.success) {
                    showToast(`Bet Placed on ${mult}x`);
                } else {
                    betEl.innerText = parseInt(betEl.innerText) - selectedAmt; // Revert
                    showToast(data.error || "Failed");
                }
            });
        }

        function initGame() {
            fetch('/api/spin', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'RESET_GAME'}) });
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 2000);
        }
    </script>
</body>
</html>
