<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dollar Kamai Premium</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Hind Siliguri', sans-serif; background-color: #0f172a; color: white; -webkit-tap-highlight-color: transparent; }
        .modal { transition: opacity 0.3s ease; opacity: 0; pointer-events: none; }
        .modal.active { opacity: 1; pointer-events: auto; }
        .loader { border: 3px solid #1e293b; border-top: 3px solid #10b981; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .level-bar { transition: width 1s ease-in-out; }
    </style>
</head>
<body class="pb-24 select-none bg-slate-900">

    <!-- Loading -->
    <div id="splash" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center">
        <i class="fa-solid fa-shield-halved text-6xl text-emerald-500 mb-4 animate-pulse"></i>
        <h1 class="text-2xl font-bold text-white">‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶∞‡¶ø‡¶ü‡¶ø ‡¶ö‡ßá‡¶ï...</h1>
        <p id="loadingText" class="text-gray-400 text-xs mt-2">IP & Device Verifying...</p>
    </div>

    <!-- DAILY BONUS MODAL -->
    <div id="bonusModal" class="modal fixed inset-0 z-[80] bg-black/90 flex items-center justify-center p-4">
        <div class="bg-slate-800 p-6 rounded-2xl text-center border border-yellow-500/30 w-full max-w-sm relative overflow-hidden">
            <div class="absolute inset-0 bg-yellow-500/10 blur-xl"></div>
            <i class="fa-solid fa-calendar-check text-5xl text-yellow-400 mb-4"></i>
            <h2 class="text-xl font-bold text-white">Daily Streak!</h2>
            <p class="text-gray-300 text-sm mb-4">‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®! ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶™‡ßá‡ßü‡ßá‡¶õ‡ßá‡¶®‡•§</p>
            <h1 class="text-4xl font-bold text-emerald-400 mb-4">+‡ß≥<span id="bonusAmt">0</span></h1>
            <button onclick="claimBonus()" class="bg-yellow-500 hover:bg-yellow-600 text-black px-6 py-2 rounded-full font-bold w-full relative z-10">Claim Now</button>
        </div>
    </div>

    <!-- TIMER MODAL -->
    <div id="timerModal" class="modal fixed inset-0 z-[60] bg-black/90 flex items-center justify-center p-4">
        <div class="bg-slate-800 p-8 rounded-2xl text-center border border-emerald-500/30 w-full max-w-sm">
            <h2 class="text-2xl font-bold text-white mb-2">‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
            <h1 id="countdown" class="text-5xl font-bold text-emerald-400 my-4">0s</h1>
            <p class="text-xs text-red-400">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡ßç‡¶≤‡ßã‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ!</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="hidden opacity-0 transition-opacity duration-500">
        <header class="bg-gradient-to-b from-slate-800 to-slate-900 p-6 rounded-b-[2.5rem] shadow-2xl border-b border-slate-800">
            <!-- Profile & Level -->
            <div class="flex justify-between items-start mb-4">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <img id="userAvatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="w-12 h-12 rounded-full border-2 border-emerald-500 bg-slate-700">
                        <div id="levelBadge" class="absolute -bottom-1 -right-1 bg-yellow-500 text-black text-[10px] font-bold px-1.5 rounded-full border border-slate-900">VIP 1</div>
                    </div>
                    <div>
                        <h2 id="userName" class="font-bold text-sm text-white">User</h2>
                        <div class="w-20 h-1.5 bg-slate-700 rounded-full mt-1 overflow-hidden">
                            <div id="xpBar" class="h-full bg-emerald-500 w-0 level-bar"></div>
                        </div>
                        <p class="text-[10px] text-emerald-400 mt-0.5">Level Progress</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-gray-400 uppercase font-bold">Balance</p>
                    <h1 class="text-3xl font-bold text-white">‡ß≥ <span id="balance">0.00</span></h1>
                </div>
            </div>
            
            <!-- Stats Grid -->
            <div class="grid grid-cols-3 gap-2 mt-4">
                <div class="bg-slate-800/50 p-2 rounded-xl text-center border border-slate-700">
                    <i class="fa-solid fa-fire text-orange-500 text-xs"></i>
                    <p class="text-[10px] text-gray-400">Streak</p>
                    <p id="streakCount" class="font-bold text-sm">0 Days</p>
                </div>
                <div class="bg-slate-800/50 p-2 rounded-xl text-center border border-slate-700">
                    <i class="fa-solid fa-list-check text-blue-500 text-xs"></i>
                    <p class="text-[10px] text-gray-400">Tasks</p>
                    <p id="taskCount" class="font-bold text-sm">0/0</p>
                </div>
                <div class="bg-slate-800/50 p-2 rounded-xl text-center border border-slate-700">
                    <i class="fa-solid fa-medal text-yellow-500 text-xs"></i>
                    <p class="text-[10px] text-gray-400">Rank</p>
                    <p id="userRank" class="font-bold text-sm">#--</p>
                </div>
            </div>
        </header>

        <main class="p-5 pb-24">
            <!-- TABS -->
            <div id="home-page" class="page-section">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-white flex items-center gap-2"><i class="fa-solid fa-bolt text-emerald-500"></i> ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï</h3>
                    <button onclick="checkDaily()" class="text-xs bg-emerald-600/20 text-emerald-400 px-3 py-1 rounded-full border border-emerald-500/30">üéÅ Bonus</button>
                </div>
                <div id="taskList" class="flex flex-col gap-3"><div class="loader mx-auto mt-10"></div></div>
            </div>

            <div id="withdraw-page" class="page-section hidden">
                <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 shadow-lg mb-6">
                    <h2 class="text-sm font-bold text-gray-400 mb-4 uppercase">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßá‡¶•‡¶°</h2>
                    <!-- Dynamic Methods -->
                    <div id="methodList" class="grid grid-cols-2 gap-3 mb-5"></div>
                    
                    <div class="space-y-4">
                        <input type="number" id="wNum" class="w-full bg-slate-900 border border-slate-600 rounded-xl p-3.5 text-white text-sm outline-none focus:border-emerald-500" placeholder="‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞">
                        <input type="number" id="wAmount" class="w-full bg-slate-900 border border-slate-600 rounded-xl p-3.5 text-white text-sm outline-none focus:border-emerald-500" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡¶ü‡¶æ‡¶ï‡¶æ)">
                    </div>
                    <button onclick="withdraw()" class="w-full bg-emerald-600 hover:bg-emerald-500 mt-6 py-3.5 rounded-xl font-bold shadow-lg transition">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
                <div class="flex items-center gap-2 mb-3"><i class="fa-solid fa-clock-rotate-left text-gray-400"></i><h3 class="font-bold text-sm text-gray-300">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</h3></div>
                <div id="historyList" class="space-y-3"></div>
            </div>
            
            <!-- Other Tabs (Refer, Leaderboard) kept similar to keep code concise -->
            <div id="refer-page" class="page-section hidden">
               <!-- Same Refer UI -->
               <div class="bg-slate-800 p-6 rounded-2xl text-center border border-slate-700"><h2 class="text-xl font-bold mb-4">‡¶á‡¶®‡¶≠‡¶æ‡¶á‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h2><input id="refLink" class="w-full bg-slate-900 p-3 rounded mb-2 text-xs text-white"><button onclick="copyRef()" class="bg-emerald-600 px-4 py-2 rounded text-sm font-bold">Copy Link</button></div>
            </div>
        </main>

        <nav class="fixed bottom-0 w-full bg-slate-900/90 backdrop-blur-lg border-t border-slate-800 flex justify-around py-3 z-40 pb-safe">
            <button onclick="nav('home')" class="nav-btn text-emerald-500 flex flex-col items-center w-16"><i class="fa-solid fa-house text-xl"></i></button>
            <button onclick="nav('refer')" class="nav-btn text-gray-500 flex flex-col items-center w-16"><i class="fa-solid fa-users text-xl"></i></button>
            <button onclick="nav('withdraw')" class="nav-btn text-gray-500 flex flex-col items-center w-16"><i class="fa-solid fa-wallet text-xl"></i></button>
        </nav>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl border border-slate-600 text-sm hidden z-[100]"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        // ‚ö†Ô∏è Firebase Config Here
        const firebaseConfig = {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†apiKey: "AIzaSyCgVhOPt9w6UhZWop6QLmq7AO3cpZtsQmI",
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†authDomain: "dollarkamai1.firebaseapp.com",
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†projectId: "dollarkamai1",
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†storageBucket: "dollarkamai1.firebasestorage.app",
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†messagingSenderId: "278970320528",
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†appId: "1:278970320528:web:30d08c635ed9e623f1ba15"
¬†¬†¬†¬†¬†¬†¬†¬†};
        try{firebase.initializeApp(firebaseConfig);}catch(e){}
        const db=firebase.firestore(); const tg=window.Telegram.WebApp;
        let user=null, selectedMethod='';

        document.addEventListener("DOMContentLoaded", async()=>{
            try{
                tg.expand();
                // 1. Security Fingerprint
                const ipRes = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipRes.json();
                const deviceID = localStorage.getItem('did') || Math.random().toString(36).substring(2);
                localStorage.setItem('did', deviceID);

                const tgUser = tg.initDataUnsafe.user || {id: 123456, first_name:"Demo"};
                const uRef = db.collection('users').doc(tgUser.id.toString());
                const uSnap = await uRef.get();

                if(uSnap.exists){
                    user=uSnap.data();
                    // Security Check
                    if(user.isBanned) return document.body.innerHTML='<div class="flex h-screen justify-center items-center text-red-500 font-bold bg-slate-900">BANNED</div>';
                    // Update Security Logs
                    if(user.lastIP !== ipData.ip || user.deviceID !== deviceID){
                        uRef.update({ lastIP: ipData.ip, deviceID: deviceID, lastActive: new Date() });
                    }
                } else {
                    // Register
                    await uRef.set({
                        id: tgUser.id, name: tgUser.first_name, balance: 0, 
                        joined: new Date(), ip: ipData.ip, deviceID: deviceID,
                        level: 1, xp: 0, streak: 0, lastCheckIn: null
                    });
                    user = {id:tgUser.id, name:tgUser.first_name, balance:0, level:1, xp:0, streak:0};
                }

                updateUI();
                loadTasks();
                loadMethods(); // Load dynamic payment methods

                document.getElementById('splash').style.display='none';
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('app').classList.remove('opacity-0');

            }catch(e){ alert("Error: "+e.message); }
        });

        // --- NEW FEATURES LOGIC ---

        function updateUI(){
            if(!user) return;
            // Animation for Balance
            animateValue("balance", parseFloat(document.getElementById('balance').innerText), user.balance, 1000);
            
            document.getElementById('userName').innerText = user.name;
            document.getElementById('userId').innerText = user.id;
            document.getElementById('streakCount').innerText = (user.streak||0) + ' Days';
            document.getElementById('refLink').value = `https://t.me/YourBot?start=${user.id}`;
            
            // Level Logic (Simple: 100 Taka = 1 Level)
            const level = Math.floor(user.balance / 100) + 1;
            const xp = user.balance % 100; // Progress to next level
            document.getElementById('levelBadge').innerText = level > 5 ? 'VIP' : 'Lvl '+level;
            document.getElementById('xpBar').style.width = xp + '%';
        }

        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            const obj = document.getElementById(id);
            const timer = setInterval(function() {
                current += increment;
                obj.innerHTML = current.toFixed(2);
                if (current == end) clearInterval(timer);
            }, stepTime > 10 ? stepTime : 10); // Min 10ms
        }

        // Dynamic Payment Methods
        async function loadMethods(){
            const mDiv = document.getElementById('methodList');
            const s = await db.collection('settings').doc('methods').get();
            if(s.exists && s.data().list){
                mDiv.innerHTML = '';
                s.data().list.forEach(m => {
                    const btn = document.createElement('button');
                    btn.className = "bg-slate-700 p-3 rounded-xl border border-transparent focus:border-emerald-500 text-sm font-bold transition";
                    btn.innerText = m;
                    btn.onclick = () => { selectedMethod = m; document.querySelectorAll('#methodList button').forEach(b=>b.classList.remove('border-emerald-500','text-emerald-500')); btn.classList.add('border-emerald-500','text-emerald-500'); };
                    mDiv.appendChild(btn);
                });
            } else {
                mDiv.innerHTML = '<p class="text-xs text-gray-500 col-span-2">No methods available</p>';
            }
        }

        // Daily Bonus Logic
        async function checkDaily(){
            const today = new Date().toDateString();
            if(user.lastCheckIn !== today){
                const bonus = 2; // 2 Taka Bonus
                document.getElementById('bonusAmt').innerText = bonus;
                document.getElementById('bonusModal').classList.add('active');
            } else {
                showToast("‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶®‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            }
        }

        async function claimBonus(){
            const today = new Date().toDateString();
            await db.collection('users').doc(user.id.toString()).update({
                balance: firebase.firestore.FieldValue.increment(2),
                streak: firebase.firestore.FieldValue.increment(1),
                lastCheckIn: today
            });
            user.balance += 2; user.streak += 1; user.lastCheckIn = today;
            updateUI();
            document.getElementById('bonusModal').classList.remove('active');
            showToast("‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
        }

        // Task & Withdraw (Standard Logic)
        async function loadTasks(){
            const d=document.getElementById('taskList'); d.innerHTML='';
            const s=await db.collection('tasks').where('active','==',true).get();
            let done=[]; try{const x=await db.collection('users').doc(user.id.toString()).collection('completed').get(); done=x.docs.map(y=>y.id);}catch(e){}
            document.getElementById('taskCount').innerText = `${done.length}/${s.size}`;
            s.forEach(o=>{
                const t=o.data(); const isDone=done.includes(o.id);
                d.innerHTML+=`<div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center ${isDone?'opacity-50 pointer-events-none':''}"><div><h4 class="font-bold text-sm text-gray-200">${t.title}</h4><span class="text-[10px] text-yellow-400">‚è±Ô∏è ${t.timer}s</span></div>${isDone?'<span class="text-green-500 text-xs">Done</span>':`<button onclick="doTask('${o.id}','${t.link}',${t.reward},${t.timer})" class="bg-emerald-600 text-white px-4 py-1.5 rounded text-xs font-bold">Go</button>`}</div>`;
            });
        }

        function doTask(id,link,rew,sec){
            window.open(link); document.getElementById('timerModal').classList.add('active');
            let tm=sec; const c=document.getElementById('countdown'); c.innerText=tm+'s';
            const i=setInterval(async()=>{
                tm--; c.innerText=tm+'s';
                if(tm<=0){
                    clearInterval(i); document.getElementById('timerModal').classList.remove('active');
                    await db.collection('users').doc(user.id.toString()).collection('completed').doc(id).set({at:new Date()});
                    await db.collection('users').doc(user.id.toString()).update({balance:firebase.firestore.FieldValue.increment(rew)});
                    user.balance+=rew; updateUI(); loadTasks(); showToast("Reward Added!");
                }
            },1000);
        }

        async function withdraw(){
            const n=document.getElementById('wNum').value, a=Number(document.getElementById('wAmount').value);
            if(!selectedMethod) return showToast("‡¶Æ‡ßá‡¶•‡¶° ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®");
            if(a<50 || a>user.balance) return showToast("Invalid Amount");
            await db.collection('withdrawals').add({userId:user.id, userName:user.name, number:n, amount:a, method:selectedMethod, status:'pending', date:new Date()});
            await db.collection('users').doc(user.id.toString()).update({balance:firebase.firestore.FieldValue.increment(-a)});
            user.balance-=a; updateUI(); loadHistory(); showToast("Request Sent!");
        }

        async function loadHistory(){
            const d=document.getElementById('historyList'); d.innerHTML='';
            const s=await db.collection('withdrawals').where('userId','==',user.id).orderBy('date','desc').limit(5).get();
            s.forEach(r=>{
                const t=r.data();
                const reason = t.status==='rejected' && t.reason ? `<div class="text-[10px] text-red-300 mt-1">Reason: ${t.reason}</div>` : '';
                d.innerHTML+=`<div class="bg-slate-800 p-3 rounded-lg border border-slate-700 mb-2"><div class="flex justify-between"><span class="text-xs text-gray-300">${t.method}</span><span class="text-xs font-bold ${t.status=='paid'?'text-green-500':(t.status=='rejected'?'text-red-500':'text-yellow-500')} uppercase">${t.status}</span></div><div class="font-bold text-white">‡ß≥${t.amount}</div>${reason}</div>`;
            });
        }

        function nav(p){ document.querySelectorAll('.page-section').forEach(e=>e.classList.add('hidden')); document.getElementById(p+'-page').classList.remove('hidden'); if(p=='withdraw') loadHistory(); }
        function showToast(m){const t=document.getElementById('toast');t.innerText=m;t.classList.remove('hidden');setTimeout(()=>t.classList.add('hidden'),3000);}
        function copyRef(){navigator.clipboard.writeText(document.getElementById('refLink').value);showToast("Link Copied!");}
    </script>
</body>
</html>
