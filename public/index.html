<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dollar Kamai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Hind Siliguri', sans-serif; background-color: #0f172a; color: white; -webkit-tap-highlight-color: transparent; }
        .modal { transition: opacity 0.3s ease; opacity: 0; pointer-events: none; }
        .modal.active { opacity: 1; pointer-events: auto; }
        .loader { border: 3px solid #1e293b; border-top: 3px solid #10b981; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .task-done { opacity: 0.5; filter: grayscale(100%); pointer-events: none; order: 9999; }
    </style>
</head>
<body class="pb-24 select-none bg-slate-900">

    <!-- Loading Screen -->
    <div id="splash" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-center">
        <i class="fa-solid fa-sack-dollar text-6xl text-emerald-500 mb-4 animate-bounce"></i>
        <h1 class="text-2xl font-bold text-white">‡¶°‡¶≤‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶Æ‡¶æ‡¶á</h1>
        <p id="loadingText" class="text-gray-400 text-sm mt-2">‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
    </div>

    <!-- MAINTENANCE / BLOCK SCREEN -->
    <div id="blockScreen" class="fixed inset-0 bg-slate-900 z-[90] hidden flex flex-col items-center justify-center p-6 text-center">
        <i id="blockIcon" class="fa-solid fa-triangle-exclamation text-6xl text-yellow-500 mb-4"></i>
        <h1 id="blockTitle" class="text-2xl font-bold text-white">Maintenance Mode</h1>
        <p id="blockMsg" class="text-gray-400 mt-2 text-sm">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶ï‡¶æ‡¶ú ‡¶ö‡¶≤‡¶õ‡ßá‡•§ ‡¶ï‡¶ø‡¶õ‡ßÅ‡¶ï‡ßç‡¶∑‡¶£ ‡¶™‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
    </div>

    <!-- POPUP NOTIFICATION -->
    <div id="popupModal" class="modal fixed inset-0 z-[80] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-slate-800 rounded-2xl w-full max-w-sm overflow-hidden border border-slate-700 relative animate-[bounce_1s_ease-in-out]">
            <button onclick="document.getElementById('popupModal').classList.remove('active')" class="absolute top-2 right-2 bg-black/50 text-white w-8 h-8 rounded-full z-10"><i class="fa-solid fa-xmark"></i></button>
            <img id="popImg" src="" class="w-full h-40 object-cover hidden">
            <div class="p-6 text-center">
                <h2 class="text-xl font-bold text-emerald-400 mb-2">üì¢ ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶ò‡ßã‡¶∑‡¶£‡¶æ</h2>
                <p id="popMsg" class="text-sm text-gray-300">...</p>
                <button onclick="document.getElementById('popupModal').classList.remove('active')" class="mt-4 bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold w-full">‡¶†‡¶ø‡¶ï ‡¶Ü‡¶õ‡ßá</button>
            </div>
        </div>
    </div>

    <!-- TIMER MODAL -->
    <div id="timerModal" class="modal fixed inset-0 z-[60] bg-black/90 flex items-center justify-center p-4">
        <div class="bg-slate-800 p-8 rounded-2xl text-center border border-emerald-500/30 w-full max-w-sm">
            <div class="w-20 h-20 mx-auto border-4 border-emerald-500 rounded-full flex items-center justify-center mb-4 relative">
                <i class="fa-solid fa-clock text-2xl text-emerald-500"></i>
                <div class="absolute inset-0 border-4 border-t-transparent border-emerald-200 rounded-full animate-spin"></div>
            </div>
            <h2 class="text-xl font-bold text-white mb-2">‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
            <h1 id="countdown" class="text-5xl font-bold text-emerald-400 my-4">0s</h1>
            <p class="text-xs text-red-400">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡ßç‡¶≤‡ßã‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ!</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="hidden opacity-0 transition-opacity duration-500">
        <!-- Header -->
        <header class="bg-gradient-to-b from-slate-800 to-slate-900 p-6 rounded-b-[2rem] shadow-2xl">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img id="userAvatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="w-12 h-12 rounded-full border-2 border-emerald-500 object-cover bg-slate-700">
                    <div>
                        <h2 id="userName" class="font-bold text-sm">User</h2>
                        <span class="text-[10px] text-gray-400 bg-slate-800 px-2 py-0.5 rounded-full border border-slate-700">ID: <span id="userId">...</span></span>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-gray-400 uppercase tracking-wider">‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</p>
                    <h1 class="text-2xl font-bold text-white">‡ß≥ <span id="balance">0.00</span></h1>
                </div>
            </div>
            <!-- Marquee -->
            <div class="mt-6 bg-slate-800/50 border border-slate-700 rounded-lg p-2 flex items-center gap-2 overflow-hidden">
                <div class="bg-emerald-500/10 p-1.5 rounded text-emerald-400"><i class="fa-solid fa-bullhorn text-xs"></i></div>
                <marquee id="noticeText" direction="left" scrollamount="4" class="text-xs text-gray-300 font-medium">Loading...</marquee>
            </div>
        </header>

        <main class="p-5">
            <!-- HOME TAB -->
            <div id="home-page" class="page-section">
                <button onclick="openLink('https://t.me/DollarKamai')" class="w-full bg-blue-600/10 border border-blue-500/30 p-3 rounded-xl flex items-center justify-between mb-5 group hover:bg-blue-600/20 transition">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-500 p-2 rounded-lg text-white"><i class="fa-brands fa-telegram"></i></div>
                        <div class="text-left">
                            <h4 class="font-bold text-sm text-blue-100">‡¶ú‡ßü‡ßá‡¶® ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h4>
                            <p class="text-[10px] text-blue-300">‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶™‡ßá‡¶§‡ßá ‡¶ú‡ßü‡ßá‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</p>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-blue-400"></i>
                </button>
                <h3 class="font-bold text-white mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check text-emerald-500"></i> ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h3>
                <div id="taskList" class="flex flex-col gap-3 pb-20"><div class="loader mx-auto mt-10"></div></div>
            </div>

            <!-- LEADERBOARD TAB (NEW) -->
            <div id="leader-page" class="page-section hidden">
                <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 text-center mb-4">
                    <i class="fa-solid fa-trophy text-4xl text-yellow-400 mb-2"></i>
                    <h2 class="text-xl font-bold text-white">Top 20 Earners</h2>
                    <p class="text-xs text-gray-400">‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡¶á‡¶®‡¶ï‡¶æ‡¶Æ‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶Æ‡ßá‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞</p>
                </div>
                <div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="bg-slate-700 text-white text-xs uppercase font-bold"><tr><th class="p-3">Rank</th><th class="p-3">User</th><th class="p-3 text-right">Balance</th></tr></thead>
                        <tbody id="leaderList" class="divide-y divide-slate-700"></tbody>
                    </table>
                </div>
            </div>

            <!-- REFER TAB -->
            <div id="refer-page" class="page-section hidden">
                <div class="bg-slate-800 p-6 rounded-2xl text-center border border-slate-700">
                    <i class="fa-solid fa-gift text-5xl text-emerald-500 mb-4 animate-bounce block"></i>
                    <h2 class="text-xl font-bold mb-2">‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                    <p class="text-gray-400 text-sm mb-4">‡¶¨‡ßã‡¶®‡¶æ‡¶∏: <span class="text-emerald-400 font-bold">‡ß≥3</span></p>
                    <div class="bg-slate-900 p-3 rounded-lg flex items-center gap-2 border border-slate-600 mb-4">
                        <input id="refLink" readonly class="bg-transparent text-xs text-gray-300 w-full outline-none" value="Loading...">
                        <button onclick="copyRef()" class="text-emerald-500 font-bold text-xs uppercase"><i class="fa-regular fa-copy text-lg"></i></button>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-slate-700/30 p-3 rounded-xl"><p class="text-xs text-gray-400">Total Ref</p><h3 id="totalRef" class="text-xl font-bold mt-1">0</h3></div>
                        <div class="bg-slate-700/30 p-3 rounded-xl"><p class="text-xs text-gray-400">Earnings</p><h3 id="refEarn" class="text-xl font-bold mt-1 text-emerald-400">‡ß≥0</h3></div>
                    </div>
                </div>
            </div>

            <!-- WITHDRAW TAB -->
            <div id="withdraw-page" class="page-section hidden">
                <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-lg">
                    <h2 class="text-sm font-bold text-gray-400 mb-3 uppercase">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßá‡¶•‡¶°</h2>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <button onclick="setMethod('bkash')" id="btn-bkash" class="bg-slate-700 p-3 rounded-xl border border-transparent focus:border-pink-500 text-sm font-bold transition">bKash</button>
                        <button onclick="setMethod('nagad')" id="btn-nagad" class="bg-slate-700 p-3 rounded-xl border border-transparent focus:border-orange-500 text-sm font-bold transition">Nagad</button>
                    </div>
                    <div class="space-y-3">
                        <input type="number" id="wNum" class="w-full bg-slate-900 border border-slate-600 rounded-xl p-3 text-white text-sm outline-none" placeholder="Number (017...)">
                        <input type="number" id="wAmount" class="w-full bg-slate-900 border border-slate-600 rounded-xl p-3 text-white text-sm outline-none" placeholder="Amount (Tk)">
                    </div>
                    <button onclick="withdraw()" class="w-full bg-emerald-600 hover:bg-emerald-500 mt-4 py-3 rounded-xl font-bold shadow-lg">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
                <div class="mt-6"><h3 class="font-bold text-sm text-gray-400 mb-3">‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø</h3><div id="historyList" class="space-y-2"></div></div>
            </div>
        </main>

        <nav class="fixed bottom-0 w-full bg-slate-900/95 backdrop-blur-md border-t border-slate-800 flex justify-around py-2 z-40 pb-safe">
            <button onclick="nav('home')" class="nav-btn text-emerald-500 flex flex-col items-center p-2 w-16"><i class="fa-solid fa-house text-lg mb-1"></i> <span class="text-[10px]">‡¶π‡ßã‡¶Æ</span></button>
            <button onclick="nav('leader')" class="nav-btn text-gray-500 flex flex-col items-center p-2 w-16"><i class="fa-solid fa-trophy text-lg mb-1"></i> <span class="text-[10px]">‡¶ü‡¶™</span></button>
            <button onclick="nav('refer')" class="nav-btn text-gray-500 flex flex-col items-center p-2 w-16"><i class="fa-solid fa-users text-lg mb-1"></i> <span class="text-[10px]">‡¶∞‡ßá‡¶´‡¶æ‡¶∞</span></button>
            <button onclick="nav('withdraw')" class="nav-btn text-gray-500 flex flex-col items-center p-2 w-16"><i class="fa-solid fa-wallet text-lg mb-1"></i> <span class="text-[10px]">‡¶ì‡ßü‡¶æ‡¶≤‡ßá‡¶ü</span></button>
        </nav>
    </div>

    <div id="toast" class="fixed bottom-20 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl border border-slate-600 text-sm hidden z-[70]">Message</div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Firebase Config Here ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
        const firebaseConfig = {
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†apiKey: "AIzaSyCgVhOPt9w6UhZWop6QLmq7AO3cpZtsQmI",
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†authDomain: "dollarkamai1.firebaseapp.com",
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†projectId: "dollarkamai1",
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†storageBucket: "dollarkamai1.firebasestorage.app",
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†messagingSenderId: "278970320528",
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†appId: "1:278970320528:web:30d08c635ed9e623f1ba15"
¬†¬†¬†¬†¬†¬†¬†¬†};
        
        try { firebase.initializeApp(firebaseConfig); } catch(e){}
        const db = firebase.firestore();
        const tg = window.Telegram.WebApp;
        let user = null, selectedMethod = 'bkash';

        document.addEventListener("DOMContentLoaded", async () => {
            try {
                tg.expand();
                const tgUser = tg.initDataUnsafe.user || { id: 123456, first_name: "Demo", username: "User" };
                
                // üõ°Ô∏è SECURITY CHECKS START üõ°Ô∏è
                
                // 1. VPN Check (Timezone)
                const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
                if(!tz.includes('Dhaka') && !tz.includes('Asia/Dhaka')) {
                    showBlock('VPN Detected!', '‡¶≠‡¶ø‡¶™‡¶ø‡¶è‡¶® ‡¶Ö‡¶´ ‡¶ï‡¶∞‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'fa-globe');
                    document.getElementById('splash').style.display='none';
                    return;
                }

                // 2. One Device Check (LocalStorage)
                const storedID = localStorage.getItem('dk_uid');
                if(storedID && storedID != tgUser.id) {
                    showBlock('Multiple Accounts!', '‡¶è‡¶ï ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏‡ßá ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß‡•§', 'fa-mobile-screen');
                    document.getElementById('splash').style.display='none';
                    return;
                }
                localStorage.setItem('dk_uid', tgUser.id);

                // 3. Maintenance Check (From DB)
                const configSnap = await db.collection('settings').doc('config').get();
                const config = configSnap.exists ? configSnap.data() : {};
                
                if(config.maintenance) {
                    showBlock('Maintenance Mode', '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶ï‡¶æ‡¶ú ‡¶ö‡¶≤‡¶õ‡ßá, ‡¶ï‡¶ø‡¶õ‡ßÅ‡¶ï‡ßç‡¶∑‡¶£ ‡¶™‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'fa-screwdriver-wrench');
                    document.getElementById('splash').style.display='none';
                    return;
                }

                // üõ°Ô∏è SECURITY CHECKS END üõ°Ô∏è

                // User Logic
                const uRef = db.collection('users').doc(tgUser.id.toString());
                const uSnap = await uRef.get();

                if(uSnap.exists) {
                    user = uSnap.data();
                    if(user.isBanned) { showBlock('Account Banned', '‡¶Ö‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶ï‡ßç‡¶∞‡¶Æ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶®‡•§', 'fa-ban'); document.getElementById('splash').style.display='none'; return; }
                    if(tgUser.photo_url && user.photo !== tgUser.photo_url) uRef.update({ photo: tgUser.photo_url });
                } else {
                    const sp = tg.initDataUnsafe.start_param;
                    user = { id: tgUser.id, name: tgUser.first_name, photo: tgUser.photo_url||'', balance: 0, refCount: 0, refEarn: 0, isBanned: false };
                    await uRef.set(user);
                    if(sp && sp!=user.id) db.collection('users').doc(sp).update({balance: firebase.firestore.FieldValue.increment(3), refCount: firebase.firestore.FieldValue.increment(1), refEarn: firebase.firestore.FieldValue.increment(3)});
                }

                // Apply Settings
                if(config.notice) document.getElementById('noticeText').innerText = config.notice;
                if(config.popupText) showPopup(config.popupText, config.popupImg);

                updateUI();
                await loadTasks();

                document.getElementById('splash').style.display = 'none';
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('app').classList.remove('opacity-0');

            } catch (error) { alert("App Error: " + error.message); }
        });

        function showBlock(title, msg, icon) {
            document.getElementById('blockTitle').innerText = title;
            document.getElementById('blockMsg').innerText = msg;
            document.getElementById('blockIcon').className = `fa-solid ${icon} text-6xl text-yellow-500 mb-4`;
            document.getElementById('blockScreen').classList.remove('hidden');
        }

        function showPopup(msg, img) {
            document.getElementById('popMsg').innerText = msg;
            if(img) { document.getElementById('popImg').src = img; document.getElementById('popImg').classList.remove('hidden'); }
            document.getElementById('popupModal').classList.add('active');
        }

        function updateUI() {
            if(!user) return;
            document.getElementById('balance').innerText = user.balance.toFixed(2);
            document.getElementById('userName').innerText = user.name;
            document.getElementById('userId').innerText = user.id;
            document.getElementById('totalRef').innerText = user.refCount || 0;
            document.getElementById('refEarn').innerText = '‡ß≥ ' + (user.refEarn || 0);
            document.getElementById('refLink').value = `https://t.me/DollarKamai_bot?start=${user.id}`;
            if(user.photo) document.getElementById('userAvatar').src = user.photo;
        }

        async function loadTasks() {
            const list = document.getElementById('taskList'); list.innerHTML = '';
            const tasks = await db.collection('tasks').where('active','==',true).get();
            let done = [];
            try { const d = await db.collection('users').doc(user.id.toString()).collection('completed').get(); done = d.docs.map(x=>x.id); } catch(e){}
            let p = '', d = '';
            tasks.forEach(doc => {
                const t = doc.data(); const isDone = done.includes(doc.id);
                const h = `<div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center shadow-sm ${isDone?'task-done':''}"><div><h4 class="font-bold text-sm text-gray-200">${t.title}</h4><div class="flex gap-2 mt-1"><span class="text-[10px] bg-slate-700 px-2 rounded text-gray-400">‚è±Ô∏è ${t.timer||10}s</span><span class="text-[10px] text-emerald-400">‡ß≥${t.reward}</span></div></div>${isDone?'<button class="bg-slate-700 text-gray-500 px-4 py-2 rounded-lg text-xs font-bold">Done</button>':`<button onclick="startTask('${doc.id}','${t.link}',${t.reward},${t.timer||10})" class="bg-emerald-600 text-white px-4 py-2 rounded-lg text-xs font-bold">Start</button>`}</div>`;
                if(isDone) d+=h; else p+=h;
            });
            list.innerHTML = p+d; if(!p&&!d) list.innerHTML='<p class="text-center text-gray-500 py-5">No tasks</p>';
        }

        async function loadLeaderboard() {
            const l = document.getElementById('leaderList'); l.innerHTML = '<tr><td colspan="3" class="p-4 text-center">Loading...</td></tr>';
            const s = await db.collection('users').orderBy('balance','desc').limit(20).get();
            l.innerHTML = '';
            let rank = 1;
            s.forEach(d => { const u = d.data(); l.innerHTML+=`<tr class="border-b border-slate-700"><td class="p-3 text-emerald-400 font-bold">#${rank++}</td><td class="p-3 text-white">${u.name}</td><td class="p-3 text-right font-bold">‡ß≥${u.balance.toFixed(2)}</td></tr>`; });
        }

        function startTask(tid, link, rew, sec) {
            window.open(link, '_blank');
            const m = document.getElementById('timerModal'); const c = document.getElementById('countdown');
            m.classList.add('active'); let tm = sec; c.innerText = tm+'s';
            const i = setInterval(async () => {
                tm--; c.innerText = tm+'s';
                if(tm<=0) { clearInterval(i); m.classList.remove('active');
                    const b = db.batch(); const r = db.collection('users').doc(user.id.toString());
                    b.update(r, {balance: firebase.firestore.FieldValue.increment(rew)});
                    b.set(r.collection('completed').doc(tid), {date: new Date()});
                    await b.commit(); user.balance+=rew; updateUI(); loadTasks(); showToast(`+‡ß≥${rew} Added!`);
                }
            }, 1000);
        }

        function openLink(u){ window.open(u, '_blank'); }
        function setMethod(m){ selectedMethod=m; document.querySelectorAll('#btn-bkash, #btn-nagad').forEach(b=>b.classList.remove('border-emerald-500','text-emerald-500')); document.getElementById('btn-'+m).classList.add('border-emerald-500','text-emerald-500'); }
        async function withdraw(){
            const n=document.getElementById('wNum').value, a=Number(document.getElementById('wAmount').value);
            if(!n || a<50 || a>user.balance) return showToast("Invalid Request");
            await db.collection('withdrawals').add({userId:user.id, userName:user.name, number:n, amount:a, method:selectedMethod, status:'pending', date: new Date()});
            await db.collection('users').doc(user.id.toString()).update({balance: firebase.firestore.FieldValue.increment(-a)});
            user.balance-=a; updateUI(); loadHistory(); showToast("Success!");
        }
        async function loadHistory(){
            const d=document.getElementById('historyList'); d.innerHTML='';
            const s=await db.collection('withdrawals').where('userId','==',user.id).orderBy('date','desc').limit(5).get();
            s.forEach(r=>{ const t=r.data(); d.innerHTML+=`<div class="bg-slate-800 p-2 rounded flex justify-between text-xs border border-slate-700"><span>${t.method}-${t.amount}</span><span class="${t.status=='paid'?'text-green-500':'text-yellow-500'} uppercase">${t.status}</span></div>` });
        }
        function nav(p){ document.querySelectorAll('.page-section').forEach(e=>e.classList.add('hidden')); document.getElementById(p+'-page').classList.remove('hidden'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('text-emerald-500')); event.currentTarget.classList.add('text-emerald-500'); if(p=='withdraw') loadHistory(); if(p=='leader') loadLeaderboard(); }
        function copyRef(){ navigator.clipboard.writeText(document.getElementById('refLink').value); showToast("Copied"); }
        function showToast(m){ const t=document.getElementById('toast'); t.innerText=m; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),3000); }
    </script>
</body>
</html>
